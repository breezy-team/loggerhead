<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<tal:block define="onload string:load()">
  <html xmlns="http://www.w3.org/1999/xhtml" metal:use-macro="macros/main">
    <head>
      <title metal:fill-slot="title"
             tal:content="string:${branch/friendly_name} : revision ${change/revno}">
      </title>

      <metal:block fill-slot="header_extras">
        <link rel="stylesheet" type="text/css" media="all"
              tal:attributes="href python:branch.static_url('/static/css/diff.css')"/>
      </metal:block>
    </head>

    <body>

      <tal:block metal:fill-slot="heading">
        <h1>
          <tal:has-link condition="branch/branch_link">
            <a tal:attributes="href branch/branch_link"
               tal:content="branch/friendly_name">
              nice/branch/name
            </a>
          </tal:has-link>
          <tal:no-link condition="not: branch/branch_link">
            <span metal:use-macro="breadcrumbs/directory"></span>
          </tal:no-link>
          <span>: <tal:revno content="change/revno"></tal:revno>
            <tal:compare-to condition="python:compare_revid is not None">
              (compared to revision <tal:block content="python:history.get_revno(compare_revid)" />)
            </tal:compare-to>
        </span></h1>
        <tal:branch-info replace="structure python:branchinfo(branch)" />
        <ul id="submenuTabs">
          <li id="first"><a tal:attributes="href python:url(['/files', change.revno]);
                                            title string:browse files at revision ${change/revno}"
                            tal:content="string:browse files at revision ${change/revno}"></a></li>
          <li tal:condition="python:remember != change.revno">
            <a tal:attributes="href python:url(['/revision', change.revno], remember=change.revno, compare_revid=None);
                               title string:compare with another revision"
               tal:content="string:Compare with another revision"></a></li>
          <li tal:condition="python:(remember is not None) and (compare_revid is None) and (change.revno != remember)" >
            <a tal:attributes="href python:url(['/revision', change.revno], compare_revid=history.get_revno(remember))">
              compare with revision <tal:b content="python:history.get_revno(remember)" />
            </a>
          </li>
          <li>
            <a tal:condition="python:len(change.parents) > 0 and compare_revid is None"
               tal:attributes="href python:url(['/diff', change.revno], clear=1)">download diff</a>
            <a tal:condition="python:compare_revid is not None"
               tal:attributes="href python:url(['/diff', change.revno, history.get_revno(compare_revid)], clear=1)">download diff</a>
          </li>
          <li id="last"><a tal:attributes="href python:url(['/changes', change.revno]);
                                           title string:view history from revision ${change/revno}"
                           tal:content="string:view history from revision ${change/revno}"></a></li>
        </ul>

        <tal:we-are-comparing condition="python:compare_revid is not None">
          <ul id="submenuTabs">
            <li id="first">
              <a tal:attributes="href python:url([ '/revision', history.get_revno(compare_revid) ], remember=change.revno, compare_revid=change.revno)">
                reverse the comparison (<tal:b content="change/revno" /> to <tal:b content="python:history.get_revno(compare_revid)" />)
              </a>
            </li>
            <li id="last">
              <a tal:attributes="href python:url(['/revision', change.revno], remember=None, compare_revid=None)">
                stop comparing with revision <tal:b content="python:history.get_revno(compare_revid)" />
              </a>
            </li>
          </ul>
        </tal:we-are-comparing>

        <tal:revision-info replace="structure python:revisioninfo(url, branch, change, modified_file_link_rev)" />
        <p class="expand" id="expand_all" style="display:none;"><a tal:attributes="href string:javascript:toggle_expand_all_revisionview('open')">
            <img tal:attributes="src python:branch.static_url('/static/images/treeCollapsed.png')"
                 alt="expand all" /> expand all</a>
        </p>
        <p class="expand" id="collapse_all"><a tal:attributes="href string:javascript:toggle_expand_all_revisionview('close')">
            <img tal:attributes="src python:branch.static_url('/static/images/treeExpanded.png')"
                 alt="collapse all" /> collapse all</a>
        </p>
        <!-- Table -->
        <p class="codin"><img tal:attributes="src python:branch.static_url('/static/images/newCode.gif')" alt="added" /> added</p>
        <p class="codin"><img tal:attributes="src python:branch.static_url('/static/images/deleteCode.gif')" alt="removed" /> removed</p>
        <div class="clear"><!-- --></div>

      </tal:block>

      <div metal:fill-slot="content">
        <div class="diff"
             tal:repeat="item change/changes/modified">

          <div class="diffBox">
            <img tal:attributes="src python:branch.static_url('/static/images/treeExpanded.png');
                                 title python:branch.static_url('/static/images/treeCollapsed.png');
                                 alt python:branch.static_url('/static/images/treeExpanded.png')"
                 class="expand_diff" />
            <a tal:attributes="href python:url(['/annotate', change.revno], clear=1, file_id=item.file_id);
                               id string:${item/filename}-s;
                               title string:Annotate ${item/filename}"
               tal:content="item/filename">
            </a>
          </div>
          <div class="psuedotable diffinfo"
               tal:repeat="chunk item/chunks">

            <tal:block condition="not:repeat/chunk/start">
              <div class="lineNumber separate"></div>
              <div class="lineCode separate"></div>
              <div class="lineNumber separate"></div>
              <div class="lineCode separate"></div>
              <div class="clear"><!-- --></div>
            </tal:block>

            <div class="pseudorow"
                 tal:repeat="line chunk/diff">
              <div class="lineNumber"
                   tal:content="structure python:util.fill_div(line.old_lineno)"></div>

              <div class="lineNumber"
                   tal:content="structure python:util.fill_div(line.new_lineno)"></div>
              <div tal:attributes="class string:lineCode-u ${line/type}"
                   tal:content="structure python:util.fill_div(util.html_clean(line.line))"></div>
              <div class="clear"><!-- --></div>
            </div>
          </div>
        </div>

        <ul tal:condition="python:navigation.prev_page_revid or navigation.next_page_revid"
            id="pages">
          <li tal:condition="navigation/prev_page_revid"
              class="previous">
            <a tal:attributes="href navigation/prev_page_url">&laquo; Previous</a>
          </li>
          <!-- FIXME: Leaving this to eventually show page numbers. Can't show all of them,
               so some magic has to be done to just show the previous and next N page numbers

               <li class="active">1</li>
               <tal:block tal:repeat="page_number python:range(navigation.page_count)">
                 <li><a href="#"
                        tal:content="page_number"></a></li>
               </tal:block>-->
          <li tal:condition="navigation/next_page_revid"
              class="next">
            <a tal:attributes="href navigation/next_page_url">Next &raquo;</a>
          </li>
        </ul>

      </div>
    </body>
  </html>
</tal:block>
