<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<tal:block define="onload string:load()">
  <html xmlns="http://www.w3.org/1999/xhtml" metal:use-macro="macros/main">
    <head>
      <title metal:fill-slot="title"
             tal:content="string:${branch/friendly_name} : revision ${change/revno}">
        ${branch.friendly_name} : revision ${change.revno}
      </title>

      <metal:block fill-slot="header_extras">
        <script type="text/javascript"
                tal:attributes="src python:branch.static_url('/static/javascript/collapse.js')">
        </script>
      </metal:block>
    </head>

    <body>

      <h1 metal:fill-slot="heading">
        <span class="branch-name" tal:content="branch/friendly_name">
          ${branch.friendly_name}
        </span>
        : revision
        <tal:revno content="change/revno">
          ${change.revno}
        </tal:revno>
        <tal:compare-to condition="python:compare_revid is not None">
          (compared to revision <tal:b content="python:history.get_revno(compare_revid)" />)
        </tal:compare-to>
      </h1>

      <div metal:fill-slot="content">
        <div class="links">
          <div>
            <b>&#8594;</b>
            <a tal:attributes="href python:url(['/files', change.revno])">
              browse files at revision <tal:b content="change/revno" />
            </a>
          </div>
          <div>
            <b>&#8594;</b>
            <a tal:attributes="href python:url(['/changes'], start_revid=change.revno)">
              view history from revision <tal:b content="change/revno" />
            </a>
          </div>
          <div tal:condition="python:(remember is not None) and (compare_revid is None) and remember != revid" >
            <b>&#8594;</b>
            <a tal:attributes="href python:url(['/revision', change.revno], compare_revid=history.get_revno(remember))">
              compare with revision <tal:b content="python:history.get_revno(remember)" />
            </a>
          </div>
          <div  tal:condition="python:remember != revid">
            <b>&#8594;</b>
            <a tal:attributes="href python:url(['/revision', change.revno], remember=change.revno, compare_revid=None)">
              compare with another revision
            </a>
          </div>
          <tal:we-are-comparing condition="python:compare_revid is not None">
            <div>
              <b>&#8594;</b>
              <a tal:attributes="href python:url([ '/revision', history.get_revno(compare_revid) ], remember=change.revno, compare_revid=change.revno)">
                reverse the comparison (<tal:b content="change/revno" /> to <tal:b content="python:history.get_revno(compare_revid)" />)
              </a>
            </div>
            <div>
              <b>&#8594;</b>
              <a tal:attributes="href python:url(['/revision', change.revno], remember=None, compare_revid=None)">
                stop comparing with revision <tal:b content="python:history.get_revno(compare_revid)" />
              </a>
            </div>
          </tal:we-are-comparing>
        </div>

        <tal:revision-info replace="structure python:revisioninfo(url, branch, change, modified_file_link_rev)" />

        <table class="diff-option-buttons">
          <tr>
            <td>
              <tal:b content="structure python:collapse_all_button('file', branch, normal='table-row')" />
            </td>

            <td class="spacey">
              <a href="javascript:show_sbs()"
                 class="hide-all collapse-style-sbs-show"
                 title="collapse">
                <img tal:attributes="src python:branch.static_url('/static/images/nav-small-out.gif')"
                     width="22" height="10" class="collapse-triangle" />
                show side by side
              </a>
              <a href="javascript:show_unified()"
                 class="hide-all collapse-style-unified-show"
                 title="expand">
                <img tal:attributes="src python:branch.static_url('/static/images/nav-small-in.gif')"
                     width="22" height="10" class="collapse-triangle" />
                show unified diff
              </a>
            </td>

            <td class="diff-key-block diff-insert">
            </td>
            <td class="label">
              added
            </td>
            <td class="diff-key-block diff-delete">
            </td>
            <td class="label">
              removed
            </td>
          </tr>
        </table>

        <div class="diff"
             tal:condition="change/changes/modified"
             tal:define="uniqs python:{}">
          <!-- ! side-by-side diff -->
          <table class="diff-block collapse-style-sbs-content">
            <tal:block repeat="item change/changes/modified">
              <tal:u define="u python:util.uniq(uniqs, item.file_id)">
                <tr>
                  <th class="filename" colspan="4">
                    <tal:b content="structure python:collapse_button('file', u, branch, normal='table-row')" />
                    <a tal:attributes="href  python:url(['/annotate', change.revno], file_id=item.file_id);
                                       name  string:${item/filename}-s;
                                       title string:Annotate ${item/filename}"
                       tal:content="item/filename">
                      ${item.filename}
                    </a>
                  </th>
                </tr>

                <tal:block repeat="chunk item/sbs_chunks">
                  <tr tal:attributes="class string:diff-chunk collapse-file-${u}-content">
                    <th class="lineno">
                      old
                    </th>
                    <th>
                    </th>
                    <th class="lineno">
                      new
                    </th>
                    <th>
                    </th>
                  </tr>
                  <tr tal:repeat="line chunk/diff"
                      tal:attributes="class string:diff-chunk collapse-file-${u}-content">
                    <tal:block condition="line/old_lineno">
                      <td class="lineno"
                          tal:content="line/old_lineno">
                        ${line.old_lineno}
                      </td>
                      <td tal:attributes="class string:diff-${line/old_type}"
                          tal:content="line/old_line">
                        ${line.old_line}
                      </td>
                    </tal:block>
                    <tal:block condition="not:line/old_lineno">
                      <td class="lineno-skip"
                          tal:content="line/old_lineno">
                        ${line.old_lineno}
                      </td>
                      <td tal:attributes="class string:diff-${line/old_type}-skip"
                          tal:content="line/old_line">
                        ${line.old_line}
                      </td>
                    </tal:block>
                    <tal:block condition="line/new_lineno">
                      <td class="lineno"
                          tal:content="line/new_lineno">
                        ${line.new_lineno}
                      </td>
                      <td tal:attributes="class string:diff-${line/new_type}"
                          tal:content="line/new_line">
                        ${line.new_line}
                      </td>
                    </tal:block>
                    <tal:block condition="not:line/new_lineno">
                      <td class="lineno-skip"
                          tal:content="line/new_lineno">
                        ${line.new_lineno}
                      </td>
                      <td tal:attributes="class string:diff-${line/new_type}-skip"
                          tal:content="line/new_line">
                        ${line.new_line}
                      </td>
                    </tal:block>
                  </tr>
                  <tr tal:attributes="class string:diff-chunk-spacing collapse-file-${u}-content">
                    <td colspan="4">
                      &nbsp;
                    </td>
                  </tr>
                </tal:block>
                <tr class="diff-spacing">
                  <td colspan="4">
                    &nbsp;
                  </td>
                </tr>
              </tal:u>
            </tal:block>
          </table>

          <!-- ! unified diff -->
          <table class="diff-block collapse-style-unified-content">
            <tal:block repeat="item change/changes/modified">
              <tal:u define="u python:util.uniq(uniqs, item.file_id)">
                <tr>
                  <th class="filename" colspan="4">
                    <tal:b content="structure python:collapse_button('file', u, branch, normal='table-row')" />
                    <a tal:attributes="href  python:url(['/annotate', change.revno], file_id=item.file_id);
                                       name  string:${item/filename}-u;
                                       title string:Annotate ${item/filename}"
                       tal:content="item/filename">
                      ${item.filename}
                    </a>
                  </th>
                </tr>

                <tal:block repeat="chunk item/chunks">
                  <tr tal:attributes="class string:diff-chunk collapse-file-${u}-content">
                    <th class="lineno">
                      old
                    </th>
                    <th class="lineno">
                      new
                    </th>
                    <th>
                    </th>
                    <th>
                    </th>
                  </tr>
                  <tr tal:repeat="line chunk/diff"
                      tal:attributes="class string:diff-chunk collapse-file-${u}-content">
                    <td class="lineno"
                        tal:content="line/old_lineno">
                      ${line.old_lineno}
                    </td>
                    <td class="lineno"
                        tal:content="line/new_lineno">
                      ${line.new_lineno}
                    </td>
                    <td tal:attributes="class string:diff-${line/type} text"
                        tal:content="line/line">
                      ${line.line}
                    </td>
                    <td>
                    </td>
                  </tr>
                  <tr tal:attributes="class string:diff-chunk-spacing collapse-file-${u}-content">
                    <td colspan="4">
                      &nbsp;
                    </td>
                  </tr>
                </tal:block>
                <tr class="diff-spacing">
                  <td colspan="4">
                    &nbsp;
                  </td>
                </tr>
              </tal:u>
            </tal:block>
          </table>
        </div>

        <div tal:condition="python:navigation.prev_page_revid or navigation.next_page_revid"
             class="bar">
          <table>
            <tr>
              <td class="buttons">
                <a tal:condition="navigation/prev_page_revid"
                   tal:attributes="href navigation/prev_page_url">
                  &lt; revision
                  <tal:r content="python:history.get_revno(navigation.prev_page_revid)" />
                </a>
	      </td>
 	      <td class="rbuttons" align="right">
                <a tal:condition="navigation/next_page_revid"
                   tal:attributes="href navigation/next_page_url">
                  revision
                  <tal:r content="python:history.get_revno(navigation.next_page_revid)" />
                  &gt;
                </a>
 	      </td>
 	    </tr>
          </table>
        </div>
      </div>
    </body>
  </html>
</tal:block>
