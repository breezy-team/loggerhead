<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <title>
      <tal:branch-name content="branch/friendly_name">
        ${branch.friendly_name}
      </tal:branch-name>
      : revision
      <tal:revno content="change/revno">
        ${change.revno}
      </tal:revno>
    </title>

    <link rel="stylesheet"
          tal:attributes="href python:tg.url('/static/css/zptstyle.css')" />

    <script type="text/javascript"
            tal:attributes="src python:tg.url('/static/javascript/collapse.js')">
    </script>

    <script type="text/javascript">
      <!--
      function show_sbs() {
          collapseDisplay('style', 'sbs', 'table');
          collapseDisplay('style', 'unified', 'none');
          document.cookie='diff=sbs';
      }
      function show_unified() {
          collapseDisplay('style', 'unified', 'table');
          collapseDisplay('style', 'sbs', 'none');
          document.cookie='diff=unified';
      }
      function load() {
          sortCollapseElements();
          if (document.cookie.indexOf('diff=unified') >= 0) { show_unified(); }
      }
      // -->
    </script>
  </head>

  <body onload="javascript:load()">

    <tal:navigation content="structure here/navigation.pt" />

    <h1>
      <span class="branch-name" tal:content="branch/friendly_name">
        ${branch.friendly_name}
      </span>
      : revision
      <tal:revno content="change/revno">
        ${change.revno}
      </tal:revno>
      <span tal:condition="python:compare_revid is not None">
        (compared to revision <tal:b replace="python:history.get_revno(compare_revid)" />)
      </span>
    </h1>

    <div class="links">
      <div>
        <b>&#8594;</b>
        <a tal:attributes="href python:url([ '/files', revid ])">
          browse files
        </a>
      </div>
      <div>
        <b>&#8594;</b>
        <a tal:attributes="href python:url(['/changes'], start_revid=revid)">
          view branch changes
        </a>
      </div>
      <div tal:condition="python:compare_revid is None" >
        <b>&#8594;</b>
        <a tal:attributes="href python:url([ '/bundle', revid, 'bundle.txt' ])">
          view/download patch
        </a>
      </div>
      <div tal:condition="python:compare_revid is not None" >
        <b>&#8594;</b>
        <a tal:attributes="href python:url([ '/bundle', revid, compare_revid, 'bundle.txt' ])">
          view/download patch
        </a>
      </div>
      <div tal:condition="python:(remember is not None) and (compare_revid is None)" >
        <b>&#8594;</b>
        <a tal:attributes="href python:url([ '/revision', revid ], compare_revid=remember)">
          compare with revision ${history.get_revno(remember)}
        </a>
      </div>
      <div  tal:condition="python:remember != revid">
        <b>&#8594;</b>
        <a tal:attributes="href python:url([ '/revision', revid ], remember=revid, compare_revid=None)">
          compare with another revision
        </a>
      </div>
      <div tal:condition="python:compare_revid is not None">
        <b>&#8594;</b>
        <a tal:attributes="href python:url([ '/revision', revid ], remember=None, compare_revid=None)">
          stop comparing to revision ${history.get_revno(compare_revid)}
        </a>
      </div>
    </div>

    <tal:revision-info replace="structure python:revisioninfo(url, branch, change, True)" />

    <table class="diff-option-buttons">
      <tr>
        <td>
	  <a class="hide-all collapse-file-hideall"
	     href="javascript:collapseAllDisplay('file','none')">
	    <img tal:attributes="src python:tg.url('/static/images/nav-small-down.gif')"
	         width="10" height="10" alt="collapse"
	         class="collapse-triangle" />collapse all</a>
	  <a class="hide-all collapse-file-showall"
	     href="javascript:collapseAllDisplay('file','table-row')">
	    <img tal:attributes="src python:tg.url('/static/images/nav-small-right.gif')"
	         width="10" height="10" alt="expand"
	         class="collapse-triangle" />expand all</a>
        </td>

        <td class="spacey">
          <a href="javascript:show_sbs()"
             class="hide-all collapse-style-sbs-show"
             title="collapse">
            <img tal:attributes="src python:tg.url('/static/images/nav-small-out.gif')"
                 width="22" height="10" class="collapse-triangle" />
            show side by side
          </a>
          <a href="javascript:show_unified()"
             class="hide-all collapse-style-unified-show"
             title="expand">
            <img tal:attributes="src python:tg.url('/static/images/nav-small-in.gif')"
                 width="22" height="10" class="collapse-triangle" />
            show unified diff
          </a>
        </td>

        <td class="diff-key-block diff-insert">
        </td>
        <td class="label">
          added
        </td>
        <td class="diff-key-block diff-delete">
        </td>
        <td class="label">
          removed
        </td>
      </tr>
    </table>

    <!-- ! i'm not a big fan of embedding python code here, but the alternatives all seem to be worse -->
    <?python uniqs={}; ?>

    <div class="diff" py:if="change.changes.modified">
      <!-- ! side-by-side diff -->
      <table class="diff-block collapse-style-sbs-content">
        <span py:strip="True" py:for="item in change.changes.modified">
          <tr>
            <th class="filename" colspan="4">
              ${collapse_button('file', util.uniq(uniqs, item.file_id), 'table-row')}
              <a href="${branch.url([ '/annotate', change.revid ], **util.get_context(file_id=item.file_id))}"
                 name="${item.filename}-s" title="Annotate ${item.filename}">
                ${item.filename}
              </a>
            </th>
          </tr>

          <span py:strip="True" py:for="chunk in item.sbs_chunks">
            <tr class="diff-chunk collapse-file-${util.uniq(uniqs, item.file_id)}-content">
              <th class="lineno">
                old
              </th>
              <th>
              </th>
              <th class="lineno">
                new
              </th>
              <th>
              </th>
            </tr>
            <tr py:for="line in chunk.diff"
                class="diff-chunk collapse-file-${util.uniq(uniqs, item.file_id)}-content">
              <span py:if="line.old_lineno" py:strip="True">
                <td class="lineno">
                  ${line.old_lineno}
                </td>
                <td class="diff-${line.old_type}">
                  ${line.old_line}
                </td>
              </span>
              <span py:if="not line.old_lineno" py:strip="True">
                <td class="lineno-skip">
                  ${line.old_lineno}
                </td>
                <td class="diff-${line.old_type}-skip">
                  ${line.old_line}
                </td>
              </span>
              <span py:if="line.new_lineno" py:strip="True">
                <td py:if="line.new_lineno" class="lineno">
                  ${line.new_lineno}
                </td>
                <td class="diff-${line.new_type}">
                  ${line.new_line}
                </td>
              </span>
              <span py:if="not line.new_lineno" py:strip="True">
                <td py:if="not line.new_lineno" class="lineno-skip">
                  ${line.new_lineno}
                </td>
                <td class="diff-${line.new_type}-skip">
                  ${line.new_line}
                </td>
              </span>
            </tr>
            <tr class="diff-chunk-spacing collapse-file-${util.uniq(uniqs, item.file_id)}-content">
              <td colspan="4">
                &nbsp;
              </td>
            </tr>
          </span>
          <tr class="diff-spacing">
            <td colspan="4">
              &nbsp;
            </td>
          </tr>
        </span>
      </table>

      <!-- ! unified diff -->
      <table class="diff-block collapse-style-unified-content">
        <span py:strip="True" py:for="item in change.changes.modified">
          <tr>
            <th class="filename" colspan="4">
              ${collapse_button('file', util.uniq(uniqs, item.file_id), 'table-row')}
              <a href="${branch.url([ '/annotate', change.revid ], **util.get_context(file_id=item.file_id))}"
                 name="${item.filename}-u" title="Annotate ${item.filename}">${item.filename}</a>
            </th>
          </tr>

          <span py:strip="True" py:for="chunk in item.chunks">
            <tr class="diff-chunk collapse-file-${util.uniq(uniqs, item.file_id)}-content">
              <th class="lineno">
                old
              </th>
              <th class="lineno">
                new
              </th>
              <th>
              </th>
              <th>
              </th>
            </tr>
            <tr py:for="line in chunk.diff" class="diff-chunk collapse-file-${util.uniq(uniqs, item.file_id)}-content">
              <td class="lineno">
                ${line.old_lineno}
              </td>
              <td class="lineno">
                ${line.new_lineno}
              </td>
              <td class="diff-${line.type} text">
                ${line.line}
              </td>
              <td>
              </td>
            </tr>
            <tr class="diff-chunk-spacing collapse-file-${util.uniq(uniqs, item.file_id)}-content">
              <td colspan="4">
                &nbsp;
              </td>
            </tr>
          </span>
          <tr class="diff-spacing">
            <td colspan="4">
              &nbsp;
            </td>
          </tr>
        </span>
      </table>

    </div>

    <div tal:condition="python:navigation.prev_page_revid or navigation.next_page_revid"
         class="bar">
      <table>
        <tr>
          <td class="buttons">
            <a tal:condition="navigation/prev_page_revid"
               tal:attributes="href navigation/prev_page_url">
              &lt; revision
              <tal:r content="python:history.get_revno(navigation.prev_page_revid)" />
            </a>
	  </td>
 	  <td class="rbuttons" align="right">
            <a tal:condition="navigation/next_page_revid"
               tal:attributes="href navigation/next_page_url">
              revision
              <tal:r content="python:history.get_revno(navigation.next_page_revid)" />
              &gt;
            </a>
 	  </td>
 	</tr>
      </table>
    </div>

    <tal:footer content="structure here/footer.pt" />

  </body>
</html>
